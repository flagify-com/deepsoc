# DeepSOC系统架构文档

## 1. 项目概述

DeepSOC（Deep Security Operations Center）是一个革命性的安全运营解决方案，它将先进的AI技术与传统的安全运营工具完美结合，通过多智能体（Multi-Agent）架构，能够自动化处理安全事件，显著提升安全运营效率。

系统采用多Agent架构，实现了安全事件的自动分析、智能决策和自动化执行，同时保留人工干预的可能性，确保安全运营的灵活性与可靠性。

## 2. 核心功能

### 2.1 智能多Agent架构

DeepSOC系统采用了分布式多Agent架构，模拟了真实SOC团队的协作模式：

- **指挥官 (Captain)** - 统筹全局决策，负责分析安全事件、制定处理策略，并为团队分配任务
- **经理 (Manager)** - 任务分配协调者，将指挥官分配的任务转化为具体的行动
  - 安全分析员 (Analyst) - 负责信息查询类任务
  - 应急处置员 (Responder) - 负责执行具体的安全操作
  - 安全通讯员 (Coordinator) - 负责告警通知和信息传递
- **操作员 (Operator)** - 执行具体操作，将经理下发的行动转化为可执行的命令
- **执行器 (Executor)** - 连接外部工具和系统，实际执行命令并获取结果
- **专家 (Expert)** - 提供专业建议，对执行结果进行分析和总结，产生事件报告

### 2.2 自动化处理流程

系统实现了安全事件的完整处理流程：

1. 自动接收和分析安全告警
2. 智能决策响应方案
3. 自动化执行处置措施
4. 收集执行结果并生成总结
5. 支持多轮迭代处理复杂事件

### 2.3 工具集成与扩展

- 集成SOAR自动化编排系统，能调用预定义的安全剧本
- 支持各类安全工具API集成
- 可扩展的Function Calling工具集
- 支持人工参与事件处置

## 3. 技术架构

### 3.1 总体架构

DeepSOC系统采用基于Python的Flask框架构建，主要包括以下组件：

- Web服务：提供用户界面和API接口
- 多Agent服务：各个角色的AI服务进程
- 数据库：存储事件、任务和消息等数据
- WebSocket：实现实时通信
- SOAR集成：连接外部安全编排系统

系统架构图示：

```
+----------------+     +------------------+     +------------------+
|                |     |                  |     |                  |
|   Web界面      |<--->|  Web服务(Flask)  |<--->|   数据库(SQLite) |
|                |     |  /API接口        |     |                  |
+----------------+     +------------------+     +------------------+
                              ^  ^
                              |  |
                              v  v
+-----------------+     +------------------+     +------------------+
|                 |     |                  |     |                  |
| WebSocket服务   |<--->|   Agent服务群    |<--->|   SOAR集成      |
|                 |     |  (多进程)        |     |                  |
+-----------------+     +------------------+     +------------------+
                              ^  ^
                              |  |
                              v  v
                       +------------------+
                       |                  |
                       |   大模型服务     |
                       |  (LLM API)       |
                       +------------------+
```

### 3.2 数据模型

系统采用关系型数据库存储所有信息，支持SQLite和MySQL两种数据库引擎：

- SQLite - 适用于本地开发和测试环境（单机模式）
- MySQL - 适用于生产环境和高并发场景（多用户协作）

主要数据模型包括：

- **Event (事件)** - 安全事件的基本信息
- **Task (任务)** - 指挥官分配给经理的任务
- **Action (动作)** - 经理分解的具体动作
- **Command (命令)** - 操作员生成的可执行命令
- **Execution (执行)** - 执行器执行的结果
- **Message (消息)** - 系统内各组件之间的通信内容
- **Summary (总结)** - 事件处理的总结报告
- **LLMRecord (LLM记录)** - 大模型调用的记录

数据模型关系：
- 一个Event包含多个Task
- 一个Task可以分解为多个Action
- 一个Action可以转化为多个Command
- 一个Command对应一个Execution
- 各类操作都会生成对应的Message
- 专家Agent会基于执行结果生成Summary

### 3.3 组件详解

#### 3.3.1 Web服务与API

- 基于Flask框架构建
- 提供RESTful API接口
- 集成Flask-SocketIO实现实时通信
- 支持事件创建、查询、处理等操作

#### 3.3.2 多Agent服务

每个Agent都以独立进程运行，相互之间通过数据库和消息进行通信：

- **Captain服务** (captain_service.py)
  - 分析安全事件并决定处理策略
  - 为团队分配任务
  
- **Manager服务** (manager_service.py)
  - 接收指挥官的任务并分解为具体动作
  - 将动作分配给不同的操作员
  
- **Operator服务** (operator_service.py)
  - 接收经理的动作并转化为具体命令
  - 确保命令可被执行器执行
  
- **Executor服务** (executor_service.py)
  - 执行操作员下发的命令
  - 与外部系统交互并收集结果
  
- **Expert服务** (expert_service.py)
  - 分析执行结果并生成摘要
  - 管理事件的进度和状态

#### 3.3.3 大模型集成 (LLM)

- 支持通过API调用多种大模型
- 抽象层设计，可轻松切换底层模型
- 提示词模板化，易于维护和优化
- 运行时基于模板动态生成各角色提示词，可实时应用更新
- 支持记录大模型调用，方便审计和优化

#### 3.3.4 SOAR集成

- 通过自定义SOARClient连接SOAR系统
- 支持执行预定义的安全剧本
- 异步等待执行结果
- 错误重试机制

### 3.4 通信机制

系统采用多种通信方式：

1. **数据库存储** - 所有状态和数据持久化
2. **WebSocket** - 前端实时更新
3. **进程间通信** - 通过数据库和队列实现Agent之间的协作

### 3.5 提示词设计

系统对不同角色采用精心设计的提示词，包括：

- 角色定义和工作职责
- 安全背景信息
- 可用工具和能力说明
- 输出格式规范
- 最佳实践指导

## 4. 工作流程

### 4.1 事件处理流程

1. **事件创建**
   - 通过Web界面或API创建安全事件
   - 系统生成事件ID并记录基本信息

2. **指挥官分析**
   - Captain Agent获取待处理事件
   - 分析事件信息并生成处理策略
   - 创建任务并分配给Manager

3. **经理任务分解**
   - Manager获取待处理任务
   - 将任务分解为具体动作
   - 分配给Operator执行

4. **操作员命令生成**
   - Operator将动作转化为可执行命令
   - 设置命令参数和执行目标

5. **执行器执行命令**
   - Executor获取待执行命令
   - 调用外部系统或工具执行
   - 收集执行结果

6. **专家总结分析**
   - Expert分析执行结果
   - 生成执行摘要
   - 判断事件是否需要进入下一轮处理
   - 生成事件总结报告

### 4.2 实时更新

- 所有操作通过WebSocket实时推送到前端
- 支持用户在War Room中查看处理进展
- 允许用户介入并提供额外信息

## 5. 部署指南

### 5.1 环境要求

- Python 3.8+
- SQLite数据库
- 网络连接（访问LLM API和SOAR系统）

### 5.2 安装步骤

1. 克隆项目代码
2. 安装依赖包
3. 配置环境变量
4. 初始化数据库
5. 启动各个服务进程

### 5.3 服务启动

```bash
# 初始化数据库
python main.py -init

# 主服务（Web、API）
python main.py
# 指挥官
python main.py -role _captain
# 安全管理员（经理）
python main.py -role _manager
# 安全工程师（操作员）
python main.py -role _operator
# 执行器
python main.py -role _executor
# 安全专家
python main.py -role _expert
```

## 6. 大模型适配建议

针对大模型的更好理解和使用，提供以下建议：

### 6.1 提示词优化

- **角色定义**：清晰定义每个Agent的职责和权限
- **输出格式**：为每个角色定义严格的输出格式（如YAML）
- **上下文压缩**：合理压缩上下文信息，避免超出Token限制
- **示例引导**：提供典型处理流程的示例

### 6.2 异常处理

- 设计重试机制，处理大模型偶发性失败
- 添加输出验证，确保符合预期格式
- 实现熔断机制，防止重复失败造成资源浪费

### 6.3 知识库扩展

- 为大模型提供更详细的网络安全背景知识
- 补充常见安全威胁模式和处置方法
- 定制领域特定的提示词模板

### 6.4 性能优化

- 使用异步调用减少等待时间
- 实现结果缓存，避免重复查询
- 根据任务复杂度选择不同能力的模型

### 6.5 评估与改进

- 记录和分析大模型响应质量
- 持续优化提示词和工作流程
- 收集用户反馈并进行针对性改进

## 7. 扩展方向

- **知识库集成**：接入企业安全知识库，提供上下文信息
- **威胁情报增强**：整合多源威胁情报
- **可视化分析**：增强事件分析与可视化能力
- **多模型协作**：同时调用多个专业化大模型
- **学习与调优**：基于历史案例提升处理效率

## 8. 结论

DeepSOC是一个创新的安全运营解决方案，通过多Agent架构和大模型技术，实现了安全事件的智能处理。系统不仅能够自动化执行常规任务，还能够智能分析和决策，大幅提升安全运营效率。

该系统的模块化设计和开放架构使其具有极强的扩展性，可以根据组织需求不断优化和增强功能。随着大模型技术的进步，DeepSOC有望在未来实现更加智能和自动化的安全运营。 